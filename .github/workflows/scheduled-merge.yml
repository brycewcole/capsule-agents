name: Scheduled Release Merge

on:
  schedule:
    # Runs at 11:00 UTC every Monday (7am EDT / 6am EST)
    - cron: '0 11 * * 1'
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-next-to-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if next has changes
        id: check_changes
        run: |
          git fetch origin next main
          # Check if there are commits in next that aren't in main
          COMMITS=$(git log origin/main..origin/next --oneline)
          if [ -z "$COMMITS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new changes in next branch to merge"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes found in next branch:"
            echo "$COMMITS"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head next --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, skipping creation"
          else
            # Create PR from next to main
            BODY="Automated weekly merge of \`next\` branch into \`main\` for batched release.

          This PR includes all changes that have been merged to \`next\` since the last release.

          ## Release Notes
          The release notes will be automatically generated by semantic-release when this PR is merged.

          ---
          *This PR was automatically created by the scheduled-merge workflow*"

            gh pr create \
              --base main \
              --head next \
              --title "chore: Weekly release $(date +%Y-%m-%d)" \
              --body "$BODY"

            echo "Pull request created successfully"
          fi

      - name: No changes to merge
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "âœ“ No changes to merge from next to main"
